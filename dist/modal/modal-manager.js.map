{"version":3,"file":"modal-manager.js","sourceRoot":"","sources":["../../src/modal/modal-manager.ts"],"names":[],"mappings":"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","sourcesContent":["import { Constant } from '../constant.js';\nimport { CaptureEyeModal } from './capture-eye-modal.js';\n\nexport class ModalManager {\n  private static instance: ModalManager;\n  private modalElement: CaptureEyeModal | null = null;\n  private currentButtonElement: HTMLElement | null = null;\n\n  private constructor() {}\n\n  get isHidden() {\n    if (this.modalElement) return this.modalElement.modalHidden;\n    return true;\n  }\n\n  get nid() {\n    return this?.modalElement?.nid ?? '';\n  }\n\n  public static getInstance(): ModalManager {\n    if (!ModalManager.instance) {\n      ModalManager.instance = new ModalManager();\n    }\n    return ModalManager.instance;\n  }\n\n  public initializeModal(): void {\n    if (!this.modalElement) {\n      this.modalElement = document.createElement('capture-eye-modal');\n      document.body.appendChild(this.modalElement);\n    }\n  }\n\n  public updateModal(\n    nid: string,\n    layout: string,\n    buttonElement: HTMLElement,\n    show = true\n  ): void {\n    if (this.modalElement) {\n      // If the current button is clicked again, hide the modal\n      if (this.currentButtonElement === buttonElement) {\n        this.hideModal();\n        return;\n      }\n\n      if (\n        this.currentButtonElement &&\n        this.currentButtonElement !== buttonElement\n      ) {\n        // Unfocus the currently focused button and remove the modal\n        this.unfocusCurrentButton();\n        this.removeModal();\n      }\n\n      this.currentButtonElement = buttonElement;\n\n      if (show) {\n        this.positionModal();\n        this.modalElement.modalHidden = false;\n        this.setFocus(true);\n      }\n\n      if (this.modalElement.nid !== nid) {\n        this.modalElement.nid = nid;\n        this.modalElement.layout = layout;\n        this.modalElement.resetModalProps();\n        this.fetchAssetData(nid).then((assetData) =>\n          this.updateModalProperties(assetData)\n        );\n      }\n    }\n  }\n\n  public hideModal(): void {\n    if (this.modalElement) {\n      this.modalElement.modalHidden = true;\n      this.setFocus(false);\n      this.currentButtonElement = null;\n    }\n  }\n\n  private positionModal(): void {\n    if (this.modalElement && this.currentButtonElement) {\n      const buttonRect = this.currentButtonElement.getBoundingClientRect();\n\n      // Remove the modal from its previous parent if it has one\n      if (this.modalElement.parentElement) {\n        this.modalElement.parentElement.removeChild(this.modalElement);\n      }\n\n      // Append the modal element to the same parent as the button element\n      this.currentButtonElement.parentElement?.appendChild(this.modalElement);\n\n      // Now calculate the correct position\n      const parentRect =\n        this.currentButtonElement.parentElement?.getBoundingClientRect() || {\n          top: 0,\n          left: 0,\n        };\n\n      this.modalElement.style.position = 'absolute';\n      this.modalElement.style.top = `${buttonRect.top - parentRect.top}px`;\n      this.modalElement.style.left = `${buttonRect.left - parentRect.left}px`;\n    }\n  }\n\n  private setFocus(focused: boolean): void {\n    if (this.modalElement && this.currentButtonElement) {\n      if (focused) {\n        this.currentButtonElement.style.zIndex = '10001';\n        this.modalElement.style.zIndex = '10000';\n      } else {\n        this.currentButtonElement.style.zIndex = '1000';\n        this.modalElement.style.zIndex = '1000';\n      }\n    }\n  }\n\n  private unfocusCurrentButton(): void {\n    if (this.currentButtonElement) {\n      this.currentButtonElement.style.zIndex = '1000';\n    }\n  }\n\n  private removeModal(): void {\n    if (this.modalElement && this.modalElement.parentElement) {\n      this.modalElement.parentElement.removeChild(this.modalElement);\n    }\n  }\n\n  private async fetchAssetData(nid: string): Promise<AssetData | undefined> {\n    const headers: HeadersInit = {\n      'Content-Type': 'application/json',\n    };\n\n    try {\n      const response = await fetch(`${Constant.url.dataApi}?nid=${nid}`, {\n        method: 'GET',\n        headers,\n      });\n\n      if (!response.ok) {\n        const errorResponse = await response.json();\n        console.error(`Error ${response.status}: ${errorResponse.message}`);\n        return;\n      }\n\n      const {\n        response: { data },\n      } = await response.json();\n      console.debug(data);\n\n      if (!data) return;\n\n      const fullAssetTree = data.fullAssetTree || {};\n      const {\n        '_api_c2_assetTree.assetCreator': assetCreator = '',\n        '_api_c2_assetTree.assetTimestampCreatedReadable': assetTimestamp = '',\n        '_api_c2_assetTree.abstract': assetAbstract = '',\n        '_api_c2_assetTree.assetSourceType': assetSourceType = '',\n        '_api_c2_assetTree.usedBy': assetUsedBy = '',\n      } = fullAssetTree;\n\n      const assetData: AssetData = {\n        assetCreator,\n        assetTimestamp,\n        assetAbstract,\n        assetInitialTransaction: data.initial_transaction ?? '',\n        assetThumbnailUrl: data.thumnail_url ?? '', // [sic]\n        explorerUrl: data.initial_transaction\n          ? `${Constant.url.explorer}/tx/${data.initial_transaction}`\n          : '',\n        assetSourceType,\n        assetCaptureTime: data.integrity_capture_time ?? '',\n        assetBackendOwnerName: data.backend_owner_name ?? '',\n        assetUsedBy,\n      };\n\n      console.debug(assetData);\n      return assetData;\n    } catch (error) {\n      console.error('Fetch error:', error);\n      return;\n    }\n  }\n\n  private updateModalProperties(assetData: AssetData | undefined) {\n    if (!this.modalElement || !assetData) return;\n    this.modalElement.creatorName = assetData.assetCreator;\n    this.modalElement.date = assetData.assetTimestamp;\n    this.modalElement.abstract = assetData.assetAbstract;\n    this.modalElement.blockchain = 'Numbers Mainnet';\n    this.modalElement.transaction = assetData.assetInitialTransaction;\n    this.modalElement.thumbnailUrl = assetData.assetThumbnailUrl;\n    this.modalElement.explorerUrl = assetData.explorerUrl;\n    this.modalElement.assetSourceType = assetData.assetSourceType;\n    this.modalElement.captureTime = assetData.assetCaptureTime;\n    this.modalElement.backendOwnerName = assetData.assetBackendOwnerName;\n    this.modalElement.usedBy = assetData.assetUsedBy;\n    this.modalElement.bannerImageSrc =\n      'https://static-cdn.numbersprotocol.io/collab/defiance_media_banner.webp';\n    this.modalElement.bannerLink = 'https://defiance.media/';\n  }\n}\n\ninterface AssetData {\n  assetCreator: string;\n  assetTimestamp: string;\n  assetAbstract: string;\n  assetInitialTransaction: string;\n  assetThumbnailUrl: string;\n  explorerUrl: string;\n  assetSourceType: string;\n  assetCaptureTime: string;\n  assetBackendOwnerName: string;\n  assetUsedBy: string;\n}\n"]}